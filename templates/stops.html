<html>
  <head>
    <meta charset="utf-8" />

    <title>{{ title }}</title>

    <link rel='stylesheet' href='static/css/jquery-ui.min.css' />
    <link rel='stylesheet' href='static/css/bootstrap.min.css' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.1.0/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/MarkerCluster.Default.css" />

    <style>
      #header {
        margin: 5px;
        height: 125px;
      }

      #tableDiv {
        margin: 5px;
      }

      #map {
        position: absolute;
        width: 100%;
        height: calc(100% - 130px);
        bottom: 0px;
      }

      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        -moz-transform: translateX(-50%) translateY(-50%);
        -webkit-transform: translateX(-50%) translateY(-50%);
        transform: translateX(-50%) translateY(-50%);
        z-index: 1000;
      }

      #loadingDiv {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 60px;
        width: 220px;
        border: 1px solid;
        color: white;
        background-color: #337ab7;
        border-radius: 15px;
        border: 1px solid #2e6da4;
        padding: 20px;
      }

      #routeModalFlow {
        height: 600px;
        width: 850px;
        margin-left: -110px;
      }

      #routeModalBody {
        height: 465px;
        overflow-y: auto;
      }

      #routeTripModalFlow {
        height: 600px;
        width: 850px;
        margin-left: -110px;
      }

      #routeTripModalBody {
        height: 465px;
        overflow-y: auto;
      }

      #calendarModalFlow {
        height: 435px;
        width: 1200px;
        margin-left: -300px;
      }

      #calendarModalBody {
        position: relative;
        width: 100%;
        height: 300px;
      }

      #calendarTable {
        margin: 5px 0 20px 0;
      }

      #calendarTable tr {
        display: inline-block;
      }

      #headInfo {
        width: 85px !important;
      }

      #bodyInfo {
        width: 85px !important;
      }

      [id^=calendarHead] th {
        display: inline-block;
        width: 25px;
        height: 25px;
        background-color: lightgrey;
        margin: 1px;
        font-size: 14px;
        text-align: center;
        line-height: 25px;
        vertical-align: middle;
      }

      [id^=calendarBody] td {
        display: inline-block;
        width: 25px;
        height: 25px;
        background-color: lightgrey;
        margin: 1px;
        font-size: 14px;
        text-align: center;
        line-height: 25px;
        vertical-align: middle;
      }

      #markedDate {
        background-color: #6af76c !important;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <h4>Matka.fi GTFS pysäkit</h4>
      <button onclick="location.href='/';" class="btn btn-primary btn-sm">Siirry takaisin</button>
      <button id="showMap" class="btn btn-primary btn-sm">Vaihda näkymää</button>

      <br />
      <br />

      <input placeholder="Syötä pysäkin tunnus" type="text" id="stop_id">
      <input placeholder="Syötä pysäkin nimi" type="text" id="stop_name">
      <button id="applyFilter" class="btn btn-primary btn-sm">Suodata</button>

      <br />
      <br />
    </div>

    <div id="map"></div>

    <div id="loading">
      <div id="loadingDiv">
        <h4>Haetaan aineistoja...<h4>
      </div>
    </div>

    <div id="tableDiv">
      <table class="table">
        <thead>
          <th>Tunnus</th>
          <th>Nimi</th>
          <th>LAT-koordinaatti</th>
          <th>LON-koordinaatti</th>
          <th>Näytä kartalla</th>
        </thead>
        <tbody id="tableContent">
        </tbody>
      </table>
    </div>

    <div class="modal fade" id="routeModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content" id="routeModalFlow">
          <div class="modal-header">
            <h3 class="modal-title">Pysäkin kautta kulkevat reitit</h5>
          </div>
          <div class="modal-body" id="routeModalBody">
            <table class="table">
              <thead>
                <th>Tunnus</th>
                <th>Reitin lyhyt nimi</th>
                <th>Reitin pitkä nimi</th>
              </thead>
              <tbody id="routeTableContent">
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Sulje</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="routeTripModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content" id="routeTripModalFlow">
          <div class="modal-header">
            <h3 class="modal-title">Pysäkin kautta kulkevien reittien matkat</h5>
          </div>
          <div class="modal-body" id="routeTripModalBody">
            <table class="table">
              <thead>
                <th>Tunnus</th>
                <th>Päämäärä</th>
                <th>Palvelutunnus</th>
                <th>Päivämäärät</th>
                <th>Aloitus</th>
                <th>Lopetus</th>
              </thead>
              <tbody id="routeTripTableContent">
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Sulje</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="calendarModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content" id="calendarModalFlow">
          <div class="modal-header">
            <h3 class="modal-title">Reitin ajat</h5>
          </div>
          <div class="modal-body" id="calendarModalBody">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Sulje</button>
          </div>
        </div>
      </div>
    </div>

    <script src='static/js/jquery-2.2.4.min.js'></script>
    <script src='static/js/bootstrap.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.1.0/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/leaflet.markercluster.js"></script>

    <script>
      var LAT = 65.304401;
      var LON = 24.301758;
      var ZOOM = 5;
      var TIMEOUT = 30000;

      var map = L.map('map').setView([51.505, -0.09], 13);

      L.tileLayer('http://api.digitransit.fi/map/v1/{id}/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ',
        id: 'hsl-map'
      }).addTo(map);

      map.setView(new L.LatLng(LAT, LON), ZOOM);

      var mrks = {}
      var markers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        spiderfyOnMaxZoom: false
      });

      $("#map").hide();
      $('#loading').hide();

      $("#showMap").click(function() {
        $("#map").toggle("fast", function() {
          if ($("#map").is(':hidden')) {
            $("#tableDiv").show();
          } else {
            $("#tableDiv").hide();
          }
        });
      });

      jQuery.ajaxSetup({
        beforeSend: function() {
          $('#loading').show();
        },
        complete: function() {
          $('#loading').hide();
        },
        success: function() {}
      });

      $('#applyFilter').click(function() {
        getStops();
      })

      function getStops() {
        $('#tableContent').empty();
        markers.clearLayers();

        if (!$('#stop_id').val().trim() && !$('#stop_name').val().trim()) {
          alert('Rajaa kyselyä!');
          map.setView(new L.LatLng(LAT, LON), ZOOM);
        } else {
          $.ajax({
            url: "/stops",
            type: "POST",
            data: {
              stopID: $('#stop_id').val(),
              stopName: $('#stop_name').val()
            },
            timeout: TIMEOUT,
            cache: false,

            success: (res) => {
              response = JSON.parse("[" + res + "]")

              if (response[0].length !== 0) {
                marks = {};

                for (i = 0; i < response[0].length; i++) {
                  $("#tableContent").append(
                    `<tr>
                      <td>${response[0][i].stop_id}</td>
                      <td>${response[0][i].stop_name}</td>
                      <td>${response[0][i].stop_lat}</td>
                      <td>${response[0][i].stop_lon}</td>
                      <td><a onclick="showStopOnMap('${response[0][i].stop_id}');">Näytä kartalla</a></td>
                    </tr>`
                  )

                  var marker = L.marker([response[0][i].stop_lat, response[0][i].stop_lon]);

                  marker.bindPopup(
                    `<b>Pysäkin tunnus: </b>${response[0][i].stop_id}<br />
                    <b>Pysäkin nimi: </b>${response[0][i].stop_name}<br /><br />
                    <b>Lat-koordinaatti: </b>${response[0][i].stop_lat}<br />
                    <b>Lon-koordinaatti: </b>${response[0][i].stop_lon}<br /><br />
                    <a onclick="getStopRoutes('${response[0][i].stop_id}');">Pysäkin kautta kulkevat reitit</a><br/>`,
                    { minWidth: 350, minHeight: 400 }
                  );

                  markers.addLayer(marker);
                  mrks[response[0][i].stop_id] = marker;
                }

                map.addLayer(markers);
                map.fitBounds(markers.getBounds());
              }
            },

            error: (jqXHR, textStatus) => {
              if (textStatus === "timeout") {
                  alert("Pyynnössä kesti liian kauan");
              } else {
                  alert("Tietojen hakemisessa tapahtui virhe");
              }
            }
          });
        }
      }

      function showStopOnMap(markerId) {
        $("#map").show();
        $("#tableDiv").hide();
        map.closePopup();
        map.setView(new L.LatLng(mrks[markerId]._latlng.lat, mrks[markerId]._latlng.lng), 18);
        setTimeout(() => {
          mrks[markerId].openPopup();
        }, 500);
      }

      function getStopRoutes(stop_id) {
        $('#routeTableContent').empty();

        $.ajax({
          url: "/stopRoutes",
          type: "POST",
          data: {
            stopID: stop_id
          },
          timeout: TIMEOUT,
          cache: false,

          success: (res) => {
            $('#routeModal').modal('show');

            response = JSON.parse("[" + res + "]")

            if (response[0].length !== 0) {
              for (i = 0; i < response[0].length; i++) {
                $("#routeTableContent").append(
                  `<tr>
                    <td><a onclick="getRouteTrips('${stop_id}', '${response[0][i].route_id}');">${response[0][i].route_id}</a></td>
                    <td>${response[0][i].route_short_name}</td>
                    <td>${response[0][i].route_long_name}</td>
                  </tr>`
                )
              }

            }
          },

          error: (jqXHR, textStatus) => {
            if (textStatus === "timeout") {
                alert("Pyynnössä kesti liian kauan");
            } else {
                alert("Tietojen hakemisessa tapahtui virhe");
            }
          }
        });
      }

      function getRouteTrips(stop_id, route_id) {
        $('#routeTripTableContent').empty();

        $.ajax({
          url: "/stopTrips",
          type: "POST",
          data: {
            stopID: stop_id,
            routeID: route_id
          },
          timeout: TIMEOUT,
          cache: false,

          success: (res) => {
            $('#routeTripModal').modal('show');

            response = JSON.parse("[" + res + "]");

            if (response[0].length !== 0) {
              for (i = 0; i < response[0].length; i++) {
                $("#routeTripTableContent").append(
                  `<tr>
                    <td>${response[0][i].trip_id}</td>
                    <td>${response[0][i].trip_headsign}</td>
                    <td>${response[0][i].service_id}</td>
                    <td><a onclick="getDates('${response[0][i].trip_id}');">Päivämäärät</a></td>
                    <td>${response[0][i].arrival_time}</td>
                    <td>${response[0][i].departure_time}</td>
                  </tr>`
                )
              }
            }
          },

          error: (jqXHR, textStatus) => {
            if (textStatus === "timeout") {
                alert("Pyynnössä kesti liian kauan");
            } else {
                alert("Tietojen hakemisessa tapahtui virhe");
            }
          }
        });
      }

      function getDates(trip_id) {
        $.ajax({
          url: "/tripDates",
          type: "POST",
          data: { tripID: trip_id },
          timeout: TIMEOUT,
          cache: false,

          success: (res) => {
            response = JSON.parse("[" + res + "]");

            if (response[0].length !== 0) {
              $('#calendarModal').modal('show');
              $('#calendarModalBody').empty();

              var firstYear = moment(response[0][0].date).get('year'); var firstMonth = moment(response[0][0].date).get('month') + 1;
              var lastYear = moment(response[0][response[0].length - 1].date).get('year'); var lastMonth = moment(response[0][response[0].length - 1].date).get('month') + 1;
              var dayNames = ['ma', 'ti', 'ke', 'to', 'pe', 'la', 'su'];
              var monthNames = ['Tammikuu', 'Helmikuu', 'Maaliskuu', 'Huuhtikuu', 'Toukokuu', 'Kesäkuu', 'Heinäkuu', 'Elokuu', 'Syyskuu', 'Lokakuu', 'Marraskuu', 'Joulukuu'];
              var table = document.getElementById('calendarModalBody');

              for (year = 0; year <= (lastYear - firstYear); year++) {
                table.innerHTML += `<table id="calendarTable"><thead id="calendarHead${year}"></thead><tbody id="calendarBody${year}"></tbody></table>`

                $(`#calendarHead${year}`).append(
                  `<tr id="${firstYear + year}"><th id="headInfo">${firstYear + year}</th></tr>`
                )

                for (j = 0; j < 38; j++) {
                  $(`#${firstYear + year}`).append(`<th>${dayNames[j % dayNames.length]}</th>`)
                }

                for (m = firstMonth - 1; m < lastMonth; m++) {
                  var currentMonth = moment().year(firstYear + year).month(m);
                  var monthDates = response[0].filter((date) => {
                    var currentDate = moment(date.date);
                    if (currentDate >= currentMonth.startOf('month') && currentDate <= currentMonth.endOf('month')) {
                      return true;
                    }

                    return false;
                  });

                  if (monthDates.length !== 0) {
                    $(`#calendarBody${year}`).append(`<tr id="${m}${year}"><td id="bodyInfo">${monthNames[m]}</td></tr>`)

                    var offCount = 0;
                    for (i = 1; i < 39; ) {
                      if (i >= currentMonth.startOf('month').day() && i <= (currentMonth.endOf('month').get('date') + offCount)) {
                        foundCount = 0;
                        for (j = 0; j < monthDates.length; j++) {
                          var date = moment(monthDates[j].date).format('YYYY-MM-DD');
                          var cdate = moment(currentMonth.date(i - offCount)).format('YYYY-MM-DD');

                          if (moment(date).isSame(cdate)) {
                            $(`#${m}${year}`).append(`<td id="markedDate">${i - offCount + foundCount}</td>`)
                            foundCount++;
                            i++
                            break;
                          }
                        }

                        if (foundCount === 0) {
                          $(`#${m}${year}`).append(`<td id="unMarkedDate">${i - offCount}</td>`)
                          i++;
                        }
                      } else {
                        $(`#${m}${year}`).append(`<td id="blank"></td>`)
                        offCount++;
                        i++;
                      }
                    } // end of for day
                  } // end of if

                } // end of for month
              } // end of for year
            } else {
              $('#calendarModal').modal('hide');
              alert('Reitin aikoja ei löytynyt!');
            }
          },

          error: (jqXHR, textStatus) => {
            if (textStatus === "timeout") {
                alert("Pyynnössä kesti liian kauan");
            } else {
                alert("Tietojen hakemisessa tapahtui virhe");
            }
          }
        });
      }
     </script>
   </body>
 </html>
