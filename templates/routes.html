<html>
  <head>
    <meta charset="utf-8" />

    <title>{{ title }}</title>

    <link rel='stylesheet' href='static/css/jquery-ui.min.css' />
    <link rel='stylesheet' href='static/css/bootstrap.min.css' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.1.0/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/MarkerCluster.Default.css" />

    <style>
      #header {
        margin: 5px;
      }

      #tableDiv {
        margin: 5px;
      }

      #modalFlow {
        height: 600px;
        overflow-y: auto;
      }

      #map {
        position: absolute;
        width: 100%;
        height: calc(100% - 130px);
        bottom: 0px;
      }

      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        -moz-transform: translateX(-50%) translateY(-50%);
        -webkit-transform: translateX(-50%) translateY(-50%);
        transform: translateX(-50%) translateY(-50%);
      }

      #loadingDiv {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 60px;
        width: 200px;
        border: 1px solid;
        background-color: lightGrey;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <h4>Matka.fi GTFS reittien haku</h4>
      <button onclick="location.href='/';" class="btn btn-primary btn-sm">Siirry takaisin</button>
      <button id="showMap" class="btn btn-primary btn-sm">Vaihda näkymää</button>

      <br />
      <br />

      <input placeholder="Syötä reitin tunnus" type="text" id="route_id">
      <input placeholder="Syötä reitin tarjoaja" type="text" id="route_provider">
      <input placeholder="Syötä reitin lyhyt nimi" type="text" id="route_short">
      <input placeholder="Syötä reitin nimi" type="text" id="route_long">
      <button id="applyFilter" class="btn btn-primary btn-sm">Suodata</button>

      <br />
      <br />
    </div>

    <div id="tableDiv">
      <table class="table">
        <thead>
          <th>Reitin ID</th>
          <th>Reitin tarjoaja</th>
          <th>Reitin lyhyt nimi</th>
          <th>Reitin pitkä nimi</th>
          <th>Linkki tarjoajan sivuille</th>
        </thead>
        <tbody id="tableContent">
        </tbody>
      </table>
    </div>

    <div id="map"></div>

    <div id="loading">
      <div id="loadingDiv">
        <h4>Haetaan aineistoja...<h4>
      </div>
    </div>

    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content" id="modalFlow">
          <div class="modal-header">
            <h3 class="modal-title">Reitin matkat</h5>
          </div>
          <div class="modal-body" id="modalBody">
            <table class="table">
              <thead>
                <th>Matkan ID</th>
                <th>Matkan päämäärä</th>
                <th>Matkan pysäkit</th>
                <th>Matkan päivämäärät</th>
              </thead>
              <tbody id="tripTable">
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src='static/js/jquery-2.2.4.min.js'></script>
    <script src='static/js/bootstrap.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.1.0/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/leaflet.markercluster-src.js"></script>

    <script>
      var LAT = 65.304401;
      var LON = 24.301758;
      var ZOOM = 5;

      var map = L.map('map').setView([51.505, -0.09], 13);

      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      map.panTo(new L.LatLng(LAT, LON));
      map.setZoom(ZOOM);

      var markers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        spiderfyOnMaxZoom: false
      });
      var polyline = L.polyline({

      });

      $("#map").hide();
      $('#loading').hide();

      $("#showMap").click(function() {
        $("#map").toggle("fast", function() {
          if ($("#map").is(':hidden')) {
            $("#tableDiv").show();
          } else {
            $("#tableDiv").hide();
          }
        });
      });

      jQuery.ajaxSetup({
        beforeSend: function() {
          $('#loading').show();
        },
        complete: function() {
          $('#loading').hide();
        },
        success: function() {}
      });

      $('#applyFilter').click(function() {
        getRoutes();
      })

      function getRoutes() {
        if (!$('#route_id').val().trim() && !$('#route_provider').val().trim() && !$('#route_short').val().trim() && !$('#route_long').val().trim()) {
          alert('Rajaa kyselyä!');
          map.panTo(new L.LatLng(LAT, LON));
          map.setZoom(ZOOM);
          markers.clearLayers();
          map.removeLayer(polyline);

        } else {
          $.ajax({
            url: "/routes",
            type: "POST",
            data: {
              routeName: $('#route_long').val(),
              routeID: $('#route_id').val(),
              routeProvider: $('#route_provider').val(),
              routeShort: $('#route_short').val()
            },
            timeout: 10000,
            cache: false,

            success: (res) => {
              $('#tableDiv').show();
              $("#map").hide();
              $('#tableContent').empty();

              console.log('Kysely onnistui!')
              response = JSON.parse("[" + res + "]")
              console.log(response);

              if (response[0].length !== 0) {
                for (i = 0; i < response[0].length; i++) {
                  $("#tableContent").append(
                    `<tr>
                      <td><a onclick="getTrips(${response[0][i].route_id});">${response[0][i].route_id}</a></td>
                      <td>${response[0][i].agency_name}</td>
                      <td>${response[0][i].route_short_name}</td>
                      <td>${response[0][i].route_long_name}</td>
                      <td><a href="${response[0][i].agency_url}" target="_blank">${response[0][i].agency_name}</a></td>
                    </tr>`
                  )
                }
              }
            },

            error: (jqXHR, textStatus) => {
              if (textStatus === "timeout") {
                  alert("Pyynnössä kesti liian kauan");
              } else {
                  alert("Tietojen hakemisessa tapahtui virhe");
              }
            }
          });
        }
      }

      function getTrips(route_id) {
        $.ajax({
          url: "/trips",
          type: "POST",
          data: { routeID: route_id },
          timeout: 10000,
          cache: false,

          success: (res) => {
            $('#modal').modal('show');
            $('#tripTable').empty();

            console.log('Kysely onnistui!');
            response = JSON.parse("[" + res + "]");
            console.log(response);

            if (response[0].length !== 0) {
              for (i = 0; i < response[0].length; i++) {
                $("#tripTable").append(
                  `<tr>
                    <td>${response[0][i].trip_id}</td>
                    <td>${response[0][i].trip_headsign}</td>
                    <td><a onclick="getStops('${response[0][i].trip_id}', '${response[0][i].trip_headsign}');">Pysäkit</a></td>
                    <td><a onclick="getDates('${response[0][i].trip_id}');">Päivämäärät</a></td>
                  </tr>`
                )
              }
            }
          },

          error: (jqXHR, textStatus) => {
            if (textStatus === "timeout") {
                alert("Pyynnössä kesti liian kauan");
            } else {
                alert("Tietojen hakemisessa tapahtui virhe");
            }
          }
        });
      }

      function getStops(trip_id, trip_headsign) {
        $('#modal').modal('hide');

        markers.clearLayers();
        map.removeLayer(polyline);

        $.ajax({
          url: "/tripStops",
          type: "POST",
          data: { tripID: trip_id },
          timeout: 10000,
          cache: false,

          success: (res) => {
            $('#tableDiv').hide();

            console.log('Kysely onnistui!');
            response = JSON.parse("[" + res + "]");
            console.log(response);
            var latlngs = Array();

            if (response[0].length !== 0) {
              for (i = 0; i < response[0].length; i++) {
                var marker = L.marker([response[0][i].stop_lat, response[0][i].stop_lon]);

                var aHours = 0; var dHours = 0;
                var aMinutes = 0; var dMinutes = 0;

                if (response[0][i].arrival_time !== null) {
                  aMinutes = response[0][i].arrival_time / 60;
                  aHours = Math.floor(aMinutes / 60);
                  if (aHours >= 24) { aHours = aHours - 24; }
                  aMinutes = Math.ceil((aMinutes / 60 - Math.floor(aMinutes / 60)) * 60)
                  if (aMinutes < 10 ) { aMinutes = '0' + aMinutes.toString() }
                } else {
                  aHours = '-'; aMinutes = '-';
                }

                if (response[0][i].departure_time !== null) {
                  dMinutes = response[0][i].departure_time / 60;
                  dHours = Math.floor(dMinutes / 60);
                  if (dHours >= 24) { dHours = dHours - 24; }
                  dMinutes = Math.ceil((dMinutes / 60 - Math.floor(dMinutes / 60)) * 60)
                  if (dMinutes < 10) { dMinutes = '0' + dMinutes.toString(); }
                } else {
                  dHours = '-'; dMinutes = '-';
                }

                var dec = (response[0][i].shape_dist_traveled / 1000 - Math.floor(response[0][i].shape_dist_traveled / 1000)).toString().substring(1, 5);
                var distance = Math.floor(Math.floor(response[0][i].shape_dist_traveled / 1000)).toString() + dec;

                marker.bindPopup(
                  `<b>Matkan tunniste: </b>${trip_id}<br />
                  <b>Määränpää: </b>${trip_headsign}<br /><br />

                  <b>Pysäkkiketju: </b>${response[0][i].stop_sequence}<br />
                  <b>Taitettu matka: </b>${distance}km<br />
                  <b>Saapumisaika: </b>${aHours}:${aMinutes}<br />
                  <b>Lähtöaika: </b>${dHours}:${dMinutes}<br/><br />

                  <b>Pysäkin tunniste: </b>${response[0][i].stop_id}<br />
                  <b>Pysäkin nimi: </b>${response[0][i].stop_name}<br />
                  <b>Lat-koordinaatti: </b>${response[0][i].stop_lat}<br />
                  <b>Lon-koordinaatti: </b>${response[0][i].stop_lon}<br />`
                );
                latlngs.push(marker.getLatLng());
                markers.addLayer(marker);
              }

              polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);
              map.fitBounds(polyline.getBounds());

              map.addLayer(markers);

              $("#map").show();
            }
          },

          error: (jqXHR, textStatus) => {
            if (textStatus === "timeout") {
                alert("Pyynnössä kesti liian kauan");
            } else {
                alert("Tietojen hakemisessa tapahtui virhe");
            }
          }
        });
      }

      function getDates(trip_id) {
        $.ajax({
          url: "/dates",
          type: "POST",
          data: { tripID: trip_id },
          timeout: 5000,
          cache: false,

          success: (res) => {
            console.log('Kysely onnistui!');
            response = JSON.parse("[" + res + "]");
            console.log(response);
          },

          error: (jqXHR, textStatus) => {
            if (textStatus === "timeout") {
                alert("Pyynnössä kesti liian kauan");
            } else {
                alert("Tietojen hakemisessa tapahtui virhe");
            }
          }
        });
      }

      // function getTimes(trip_id, stop_id) {
      //   $.ajax({
      //     url: "/stopTimes",
      //     type: "POST",
      //     data: {
      //       tripID: trip_id,
      //       stopID: stop_id
      //     },
      //     timeout: 5000,
      //     cache: false,
      //
      //     success: (res) => {
      //       console.log('Kysely onnistui!');
      //       response = JSON.parse("[" + res + "]")
      //       console.log(response);
      //     },
      //
      //     error: (jqXHR, textStatus) => {
      //       if (textStatus === "timeout") {
      //           alert("Pyynnössä kesti liian kauan");
      //       } else {
      //           alert("Tietojen hakemisessa tapahtui virhe");
      //       }
      //     }
      //   });
      // }
    </script>
  </body>
</html>
